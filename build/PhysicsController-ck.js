define(["easel","box2d","controllers/physics/actors/ActorsController","controllers/physics/vehicles/CatapultController","controllers/physics/vehicles/TrebuchetController","config/config"],function(e,t,n,r,i){var s=function(e,t,s,o,u,a){var f={x:0,y:0},l=Box2D.Common.Math.b2Vec2,c=Box2D.Dynamics.b2BodyDef,h=Box2D.Dynamics.b2Body,p=Box2D.Dynamics.b2FixtureDef,d=Box2D.Dynamics.b2Fixture,v=Box2D.Dynamics.b2World,m=Box2D.Collision.Shapes.b2PolygonShape,g=Box2D.Collision.Shapes.b2CircleShape,y=Box2D.Dynamics.b2DebugDraw,b=Box2D.Collision.Shapes.b2MassData,w=Box2D.Dynamics.Joints.b2RevoluteJointDef,E,S=2800,x=10,T,N,C=e.height-x,k=30,L=20,A=1/L,O,M=Date.now(),_=0,D=[],P=[],H=[],B=[],j,F=0,I=!0,q=function(e){var t=a+config.actorSettings[e].imgPath,n=config.actorSettings[e].width,r=config.actorSettings[e].height,i=config.actorSettings[e].physicsWidth,s=config.actorSettings[e].physicsHeight,u=config.actorSettings[e].density,f=config.actorSettings[e].friction,l=config.actorSettings[e].restitution,c=config.actorSettings[e].collisionCategory,h=config.actorSettings[e].bodyType,p=config.actorSettings[e].bSpriteSheet,d=config.actorSettings[e].animationObj;simpleBodyX=Math.round(Math.random()*500);simpleBodyY=C;var v=config.actorSettings[e].x,m=config.actorSettings[e].y,g={x:v,y:m},y=j.createSkin(t,n,r,g,e,p,d);o.addChild(y);var b=1,w=0,E=0;j.createActor(e,y,u,f,l,h,n,r,i,s,c)},R=function(e){var t=config.actorSettings[e],n=t.length;console.log("PhysicsController / spawnComplex: %s parts: %s",e,n);var r=new createjs.Container;for(var i=0;i<n;i++){var s=t[i],u=s.name;if(u!="joint"){var f=a+s.imgPath,l=s.width,c=s.height,h=s.spriteSheetX,p=s.spriteSheetY,d=s.physicsWidth,v=s.physicsHeight,m=s.x,g=s.y,y=s.bodyType,b=s.density,w=s.friction,E=s.restitution,S=s.collisionCategory,x=s.bSpriteSheet,T=s.animationObj,N={x:m,y:g},C=j.createSkin(f,l,c,N,u,x,T);r.addChild(C);j.createActor(u,C,b,w,E,y,l,c,d,v,S)}else switch(e){case"cavetroll":j.createJoint("revolute",s.connects);break;default:j.createJoint("distance",s.connects)}}o.addChild(r)},U=function(n){var s;switch(n){case"catapult":var u=30,f=37,l=37,c=190,h=400,p=!0,s=new r(n,e,t,o,O,u,P,H,f,l,c,h,p,a);s.spawn();break;case"trebuchet":var d=30,v=37,m=37,g=3800,y=300,p=!0,s=new i(n,e,t,o,O,d,P,H,v,m,g,y,p,a);s.spawn();break;default:}B.push(s)},z=function(e,t){switch(e){case"body-simple":q(t);break;case"body-complex":case"vehicle":R(t);break;case"blueprint":U(t)}},W=function(){O=new v(new l(0,10),!0);j=new n(P,H,O,k);X();q("floor");var t=new p;t.shape=new m;t.shape.SetAsBox(10/k,550/k);t.density=1;t.restitution=.1;t.friction=.9;var r=new c;r.type=h.b2_staticBody;r.position.x=-9/k;r.position.y=-25/k;T=O.CreateBody(r);T.CreateFixture(t);var i=new p;i.shape=new m;i.shape.SetAsBox(10/k,550/k);i.density=1;i.restitution=.1;i.friction=.9;var s=new c;s.type=h.b2_staticBody;s.position.x=(e.width*4+9)/k;s.position.y=-25/k;N=O.CreateBody(s);N.CreateFixture(i)},X=function(){var e=new y;e.SetSprite(u);e.SetRGBByHexStrokeColor("#CFB52B");e.SetRGBByHexFillColor("#8C7853");e.SetAlphaColor(.8);e.SetStrokeThickness(2);e.SetDrawScale(k);e.SetFillAlpha(.7);e.SetLineThickness(1);e.SetFlags(y.e_shapeBit|y.e_jointBit);O.SetDebugDraw(e)},V=function(e){o.removeChild(e.skin);P.splice(P.indexOf(e),1)},$=function(){console.log("PhsyicsController / update");var e=Date.now(),t=e-M;_+=t;M=e;while(_>=L){for(var n=0,r=D.length;n<r;n++){V(D[n].GetUserData());D[n].SetUserData(null);O.DestroyBody(D[n])}D=[];for(var n=0,r=P.length;n<r;n++)P[n].update();var i=B[0].getCameraFocus();s.x=i.x;s.y=i.y;O.Step(A,10,10);_-=L;O.ClearForces();O.DrawDebugData();if(H.length>30){D.push(H[0]);H.splice(0,1)}}},J=function(e){var t;for(t=O.GetBodyList();t;t=t.GetNext())if(t.GetUserData()!=null){var n=t.GetUserData().skin.name;if(n==e)return t}},K=function(e,t){var n=J(e),r=J(t)},Q=function(e){e?A=0:A=1/L;M=Date.now()},G=function(e,t){console.log("PhysicsController / trigger");switch(t){case"SPACE":B[0].setMaxMotorTorque(5e3);break;case"LEFT":case"RIGHT":B[0].setKeyPressed(t);B[0].setMotorSpeed()}};return{update:$,spawn:z,setup:W,addDebug:X,trigger:G}};return s});